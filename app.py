# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1g9rGqqvs2CiZmmSe8fj-vla-BRenPEXO
"""

import pandas as pd
import numpy as np
import joblib
from fastapi import FastAPI
from pydantic import BaseModel

model=joblib.load("house_price_model.pkl")
feature_columns=joblib.load("model_features.pkl")

class PropertyInput(BaseModel):
  location: str
  size: float
  bedrooms:int
  bathrooms:int
  year_built:int
  condition: str
  type: str
  date_sold: str

def preprocess_input(data: PropertyInput):
    X = pd.DataFrame(0, index=[0], columns=feature_columns)
    X.at[0, "size"] = data.size
    X.at[0, "bedrooms"] = data.bedrooms
    X.at[0, "bathrooms"] = data.bathrooms
    X.at[0, "year_built"] = data.year_built

    date = pd.to_datetime(data.date_sold, errors="coerce")
    X.at[0, "sale_year"] = date.year
    X.at[0, "sale_month"] = date.month
    X.at[0, "property age"] = date.year - data.year_built

    loc_col = f"location_{data.location}"
    if loc_col in X.columns:
        X.at[0, loc_col] = 1

    cond_col = f"condition_{data.condition}"
    if cond_col in X.columns:
        X.at[0, cond_col] = 1

    type_col = f"type_{data.type}"
    if type_col in X.columns:
        X.at[0, type_col] = 1

    return X


app=FastAPI(title="House Price Prediction",
            description= "Predict the price of houses using XGB model",
            version="1.00")

@app.get("/")
def health_check():
  return{"Status": "Your API is running well"}

import xgboost as xgb

@app.post("/predict")
def predict_price(input_data: PropertyInput):
    try:
        X = preprocess_input(input_data)
        dmatrix = xgb.DMatrix(X, feature_names=feature_columns)
        prediction = model.get_booster().predict(dmatrix)[0]
        return {"predicted_price": round(float(prediction), 2)}
    except Exception as e:
        return {
            "error": "Prediction failed",
            "details": str(e)
        }

if __name__ == "__main__":
    import uvicorn
    import nest_asyncio
    import threading
    nest_asyncio.apply()

    def run_uvicorn():
        uvicorn.run(app, host="0.0.0.0", port=8000)

    thread = threading.Thread(target=run_uvicorn)
    thread.start()
