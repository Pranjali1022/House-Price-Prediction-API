# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1g9rGqqvs2CiZmmSe8fj-vla-BRenPEXO
"""

import pandas as pd
import numpy as np
import joblib
import xgboost as xgb
from fastapi import FastAPI
from pydantic import BaseModel

model=joblib.load("house_price_model.pkl")
feature_columns=joblib.load("model_features.pkl")

class PropertyInput(BaseModel):
  location: str
  size: float
  bedrooms:int
  bathrooms:int
  year_built:int
  condition: str
  type: str
  date_sold: str

def preprocess_input(data: PropertyInput):
    df = pd.DataFrame([data.dict()])
    df["date_sold"] = pd.to_datetime(df["date_sold"], errors="coerce")
    df["sale_year"] = df["date_sold"].dt.year
    df["sale_month"] = df["date_sold"].dt.month
    df["property age"] = df["sale_year"] - df["year_built"]
    df = df.drop(columns=["date_sold"])
    df_encoded = pd.get_dummies(df)
    df_encoded = df_encoded.reindex(columns=feature_columns,fill_value=0)
    df_encoded = df_encoded.astype(float)
    return df_encoded

app=FastAPI(title="House Price Prediction",
            description= "Predict the price of houses using XGB model",
            version="1.00")

@app.get("/")
def health_check():
  return{"Status": "Your API is running well"}

@app.post("/predict")
def predict_price(input_data: PropertyInput):
    try:
        X = preprocess_input(input_data)
        dmatrix = xgb.DMatrix(X,feature_names=feature_columns)
        log_prediction = model.get_booster().predict(dmatrix)[0]
        price = np.expm1(log_prediction)
        return {"The Price of Your dream House can be around": round(float(price), 2)}
    except Exception as e:
        return {"error": "Prediction may be failed","details": str(e)}
